[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        off
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# ==============================================================================
# INPUT: Collect Docker container logs with container metadata
# ==============================================================================
[INPUT]
    Name              tail
    Tag               docker.*
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker_with_attrs
    DB                /var/log/flb_docker.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  5
    Docker_Mode       On
    Docker_Mode_Flush 4

# ==============================================================================
# FILTER 1: Add platform info
# ==============================================================================
[FILTER]
    Name          modify
    Match         docker.*
    Add           platform workfitai
    Add           environment docker

# ==============================================================================
# FILTER 2: Extract container/service info from Docker attrs and log content
# ==============================================================================
[FILTER]
    Name          lua
    Match         docker.*
    Script        /fluent-bit/etc/extract_service.lua
    Call          extract_container_info

# ==============================================================================
# FILTER 3: EXCLUDE non-WorkFitAI service logs
# Only keep logs where service_name matches our services
# ==============================================================================
[FILTER]
    Name          grep
    Match         docker.*
    Regex         service_name ^(auth-service|user-service|job-service|cv-service|notification-service|application-service|api-gateway|monitoring-service)$

# ==============================================================================
# FILTER 4: Parse nested JSON log from Spring Boot (logstash-logback-encoder)
# ==============================================================================
[FILTER]
    Name          parser
    Match         docker.*
    Key_Name      log
    Parser        spring_json
    Reserve_Data  On

# ==============================================================================
# FILTER 5: Normalize and enrich log fields for Kibana display
# ==============================================================================
[FILTER]
    Name          lua
    Match         docker.*
    Script        /fluent-bit/etc/extract_service.lua
    Call          normalize_log_fields

# ==============================================================================
# FILTER 6: Remove unnecessary fields to reduce noise
# ==============================================================================
[FILTER]
    Name          record_modifier
    Match         docker.*
    Remove_key    stream
    Remove_key    _p
    Remove_key    attrs

# ==============================================================================
# OUTPUT: Elasticsearch with optimized settings
# ==============================================================================
[OUTPUT]
    Name            es
    Match           docker.*
    Host            ${ELASTICSEARCH_HOST}
    Port            ${ELASTICSEARCH_PORT}
    HTTP_User       ${ELASTICSEARCH_USERNAME}
    HTTP_Passwd     ${ELASTICSEARCH_PASSWORD}
    Index           workfitai-logs
    Logstash_Format On
    Logstash_Prefix workfitai-logs
    Logstash_DateFormat %Y.%m.%d
    Time_Key        @timestamp
    Include_Tag_Key Off
    Generate_ID     On
    Suppress_Type_Name On
    Retry_Limit     3
    Buffer_Size     5MB
