[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        off
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# Collect Docker container logs
[INPUT]
    Name              tail
    Tag               docker.*
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    DB                /var/log/flb_docker.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  10

# Filter to parse Spring Boot JSON logs
[FILTER]
    Name          parser
    Match         docker.*
    Key_Name      log
    Parser        spring_json
    Reserve_Data  On
    Preserve_Key  On

# Add container metadata
[FILTER]
    Name          modify
    Match         docker.*
    Add           environment docker
    Add           platform workfitai

# Extract service name from container name
[FILTER]
    Name          lua
    Match         docker.*
    Script        /fluent-bit/etc/extract_service.lua
    Call          extract_service_name

# Output to Elasticsearch
[OUTPUT]
    Name            es
    Match           docker.*
    Host            ${ELASTICSEARCH_HOST}
    Port            ${ELASTICSEARCH_PORT}
    HTTP_User       ${ELASTICSEARCH_USERNAME}
    HTTP_Passwd     ${ELASTICSEARCH_PASSWORD}
    Index           workfitai-logs
    Logstash_Format On
    Logstash_Prefix workfitai-logs
    Logstash_DateFormat %Y.%m.%d
    Time_Key        @timestamp
    Include_Tag_Key On
    Tag_Key         fluentbit_tag
    Suppress_Type_Name On
    Retry_Limit     3

# Debug output (optional - comment out in production)
# [OUTPUT]
#     Name   stdout
#     Match  *
